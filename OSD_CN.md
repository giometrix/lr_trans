3.9 调用约定与运行时堆栈
========

操作系统严重依赖于函数调用机制。应用程序需要通过函数调用来使用操作系统服务，因此可以认为函数调用定义了操作系统服务。此外，当将上下文从一个进程切换到另一个进程时，操作系统必须要合理地处理进程各自的函数嵌套调用的情况，因此操作系统设计者必须了解功能调用的细节。以下段落定义了与函数调用相关的关键概念和机制。

*调用约定* 调用约定是指程序在函数调用时传递参数和获取返回值所采取的步骤。之所以使用了*约定*这个术语，是因为硬件并没有描述所有的细节。硬件设计对可能使用的方法进行了一些限制，编译器的编写者可以最终决定具体使用的方法。操作系统在处理中断和线程切换的过程中调用了函数，因此它必须要理解并遵循与编译器相同的约定。

*参数与参数传递* 调用函数的时候，调用者提供了一组与形式参数相对应的实际参数。商业处理器已经实现了多种参数传递的方式。示例平台展示了两种常见的方法：将参数放置在堆栈中，或者传递给通用寄存器。

*运行时堆栈与堆栈帧内容* 静态作用于语言（譬如C语言）使用运行时堆栈来存储与函数调用有关的状态。编译器在堆栈中分配足够的空间来保存被调用函数的*激活记录*。所分配的空间称为*堆栈帧*。每条激活记录包含着与该函数关联的局部变量的空间、计算期间所需要的临时存储、返回地址以及其他杂项。我们假设堆栈从较高的内存地址下降到较低的内存地址。

编译器生成创建堆栈帧所需的代码。编译器计算局部变量所需的大小以及辅助项目所需的大小，例如用于保存寄存器内容的临时空间（因此该函数可以使用寄存器进行计算，然后在之前恢复原始值）返回给呼叫者）。我们将看到，当它创建一个新的进程时，操作系统需要为进程的初始化功能构造一个堆栈帧。因此，操作系统需要确切地知道堆栈帧的布局，包括参数的位置和返回地址。例子将阐明这个概念。在下面的例子中，我们假设一个gcc编译器;其他编译器使用的调用约定可能会有所不同。
